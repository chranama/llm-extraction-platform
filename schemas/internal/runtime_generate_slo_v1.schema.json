{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "runtime_generate_slo_v1",
  "title": "RuntimeGenerateSLOSnapshotV1",
  "type": "object",
  "additionalProperties": false,

  "required": [
    "schema_version",
    "generated_at",
    "window_seconds",
    "window_end",
    "routes",
    "models",
    "totals"
  ],

  "properties": {
    "schema_version": { "const": "runtime_generate_slo_v1" },

    "generated_at": {
      "type": "string",
      "minLength": 1,
      "format": "date-time",
      "description": "When this snapshot was written."
    },

    "window_seconds": {
      "type": "integer",
      "minimum": 1,
      "maximum": 86400,
      "description": "Measurement window size in seconds."
    },

    "window_end": {
      "type": "string",
      "minLength": 1,
      "format": "date-time",
      "description": "Inclusive end time for the measured window (typically now)."
    },

    "routes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string",
        "minLength": 1
      },
      "description": "Routes included in the snapshot, e.g. ['/v1/generate','/v1/generate/batch']."
    },

    "models": {
      "type": "array",
      "default": [],
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["model_id", "requests", "errors", "latency_ms", "tokens"],
        "properties": {
          "model_id": { "type": "string", "minLength": 1 },

          "requests": {
            "type": "object",
            "additionalProperties": false,
            "required": ["total"],
            "properties": {
              "total": { "type": "integer", "minimum": 0 }
            }
          },

          "errors": {
            "type": "object",
            "additionalProperties": false,
            "required": ["total"],
            "properties": {
              "total": { "type": "integer", "minimum": 0 },
              "rate": { "type": "number", "minimum": 0, "maximum": 1 },
              "by_status": {
                "type": "object",
                "additionalProperties": {
                  "type": "integer",
                  "minimum": 0
                },
                "description": "Map of HTTP status code -> count (as strings)."
              },
              "by_code": {
                "type": "object",
                "additionalProperties": {
                  "type": "integer",
                  "minimum": 0
                },
                "description": "Map of AppError code -> count."
              }
            }
          },

          "latency_ms": {
            "type": "object",
            "additionalProperties": false,
            "required": ["p50", "p95", "p99", "avg", "max"],
            "properties": {
              "p50": { "type": "number", "minimum": 0 },
              "p95": { "type": "number", "minimum": 0 },
              "p99": { "type": "number", "minimum": 0 },
              "avg": { "type": "number", "minimum": 0 },
              "max": { "type": "number", "minimum": 0 }
            }
          },

          "tokens": {
            "type": "object",
            "additionalProperties": false,
            "required": ["prompt", "completion"],
            "properties": {
              "prompt": {
                "type": "object",
                "additionalProperties": false,
                "required": ["avg", "max"],
                "properties": {
                  "avg": { "type": "number", "minimum": 0 },
                  "max": { "type": "integer", "minimum": 0 }
                }
              },
              "completion": {
                "type": "object",
                "additionalProperties": false,
                "required": ["avg", "p95", "max"],
                "properties": {
                  "avg": { "type": "number", "minimum": 0 },
                  "p95": { "type": "number", "minimum": 0 },
                  "max": { "type": "integer", "minimum": 0 }
                }
              }
            }
          }
        }
      }
    },

    "totals": {
      "type": "object",
      "additionalProperties": false,
      "required": ["requests", "errors", "latency_ms", "tokens"],
      "properties": {
        "requests": {
          "type": "object",
          "additionalProperties": false,
          "required": ["total"],
          "properties": {
            "total": { "type": "integer", "minimum": 0 }
          }
        },

        "errors": {
          "type": "object",
          "additionalProperties": false,
          "required": ["total"],
          "properties": {
            "total": { "type": "integer", "minimum": 0 },
            "rate": { "type": "number", "minimum": 0, "maximum": 1 },
            "by_status": {
              "type": "object",
              "additionalProperties": {
                "type": "integer",
                "minimum": 0
              }
            },
            "by_code": {
              "type": "object",
              "additionalProperties": {
                "type": "integer",
                "minimum": 0
              }
            }
          }
        },

        "latency_ms": {
          "type": "object",
          "additionalProperties": false,
          "required": ["p50", "p95", "p99", "avg", "max"],
          "properties": {
            "p50": { "type": "number", "minimum": 0 },
            "p95": { "type": "number", "minimum": 0 },
            "p99": { "type": "number", "minimum": 0 },
            "avg": { "type": "number", "minimum": 0 },
            "max": { "type": "number", "minimum": 0 }
          }
        },

        "tokens": {
          "type": "object",
          "additionalProperties": false,
          "required": ["prompt", "completion"],
          "properties": {
            "prompt": {
              "type": "object",
              "additionalProperties": false,
              "required": ["avg", "max"],
              "properties": {
                "avg": { "type": "number", "minimum": 0 },
                "max": { "type": "integer", "minimum": 0 }
              }
            },
            "completion": {
              "type": "object",
              "additionalProperties": false,
              "required": ["avg", "p95", "max"],
              "properties": {
                "avg": { "type": "number", "minimum": 0 },
                "p95": { "type": "number", "minimum": 0 },
                "max": { "type": "integer", "minimum": 0 }
              }
            }
          }
        }
      }
    }
  }
}