# deploy/docker/Dockerfile.ui
# --------- UI build stage ---------
FROM node:22-alpine AS build

WORKDIR /app/ui

# Copy dependency manifests (from repo root)
COPY ui/package.json ui/package-lock.json ./

# TEMP: allow lockfile drift during smoke-test bringup
RUN npm install --no-audit --no-fund

# Copy UI source only (from repo root)
COPY ui/ ./

# ---- build-time env for Vite ----
# NOTE: UI reads config at runtime via /config.json.
# These are still useful defaults for local dev builds / fallback behavior.
ARG VITE_API_KEY
ARG VITE_API_BASE_URL=/api
ENV VITE_API_KEY=$VITE_API_KEY
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL

# ---- Authoritative UI runtime config (baked into the image) ----
# Expose config/ui.json as /config.json for the UI runtime loader.
COPY config/ui.json /app/ui/public/config.json

RUN npm run build


# --------- Nginx serve stage ---------
FROM nginx:1.27-alpine AS runtime

WORKDIR /usr/share/nginx/html
COPY --from=build /app/ui/dist ./

CMD ["nginx", "-g", "daemon off;"]